<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Hero Adventure: Final Integration</title>
    <style>
        /* --- GIAO DIỆN (UI) --- */
        body { margin: 0; overflow: hidden; background: #87ceeb; font-family: 'Segoe UI', sans-serif; user-select: none; -webkit-user-select: none; }
        
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; }
        
        /* Joystick (Bên trái) */
        #joystick-zone { 
            position: absolute; bottom: 40px; left: 40px; width: 120px; height: 120px; 
            background: rgba(255, 255, 255, 0.15); border: 2px solid rgba(255, 255, 255, 0.4); 
            border-radius: 50%; pointer-events: auto; backdrop-filter: blur(2px);
        }
        #joystick-knob { 
            position: absolute; top: 50%; left: 50%; width: 50px; height: 50px; 
            background: rgba(255, 255, 255, 0.9); border-radius: 50%; 
            transform: translate(-50%, -50%); box-shadow: 0 4px 10px rgba(0,0,0,0.3); 
        }
        
        /* Nút Tấn công (Bên phải) */
        #btn-attack { 
            position: absolute; bottom: 50px; right: 50px; width: 90px; height: 90px; 
            background: radial-gradient(circle, #ff5f5f, #cc0000); 
            border: 4px solid white; border-radius: 50%; 
            box-shadow: 0 6px 15px rgba(0,0,0,0.4); pointer-events: auto; 
            display: flex; align-items: center; justify-content: center; 
            color: white; font-weight: bold; font-size: 24px; text-shadow: 1px 1px 2px black;
        }
        #btn-attack:active { transform: scale(0.92); background: #aa0000; }

        /* Màn hình chờ tải */
        #loader-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            background: #111827; display: flex; flex-direction: column; 
            align-items: center; justify-content: center; z-index: 9999; transition: opacity 0.5s;
        }
        .spinner {
            width: 50px; height: 50px; border: 5px solid #374151; 
            border-top: 5px solid #10b981; border-radius: 50%; 
            animation: spin 1s linear infinite; margin-bottom: 20px;
        }
        #loading-text { color: #10b981; font-weight: bold; font-size: 18px; letter-spacing: 1px; }
        
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <!-- Màn hình Loading -->
    <div id="loader-screen">
        <div class="spinner"></div>
        <div id="loading-text">ĐANG KẾT NỐI GITHUB...</div>
        <div style="color: #6b7280; font-size: 12px; margin-top: 10px;">Đang tải: Hero, Animation, Meadow</div>
    </div>

    <!-- UI Điều khiển -->
    <div id="ui-layer">
        <div id="joystick-zone"><div id="joystick-knob"></div></div>
        <div id="btn-attack">⚔️</div>
    </div>

    <!-- Thư viện Three.js -->
    <script async src="https://unpkg.com/es-module-shims@1.6.3/dist/es-module-shims.js"></script>
    <script type="importmap">
        { "imports": { "three": "https://cdn.jsdelivr.net/npm/three@0.150.1/build/three.module.js", "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.150.1/examples/jsm/" } }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';

        // ==========================================
        // 1. CẤU HÌNH KẾT NỐI (Đã điền sẵn cho bạn)
        // ==========================================
        const CONFIG = {
            user: 'thuc29413-ship-it', // Tên GitHub của bạn
            repo: 'game-moi',          // Tên Kho
            branch: 'main',            // Nhánh chính
            files: {
                hero: 'hero.glb',
                map: 'meadow.glb',
                run: 'run.glb',
                attack: 'attack.glb'
            }
        };
        
        // Tạo link Raw tự động
        const getUrl = (filename) => 
            `https://raw.githubusercontent.com/${CONFIG.user}/${CONFIG.repo}/${CONFIG.branch}/${filename}`;

        // ==========================================
        // 2. KHỞI TẠO MÔI TRƯỜNG 3D
        // ==========================================
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x87ceeb); // Bầu trời xanh
        scene.fog = new THREE.Fog(0x87ceeb, 15, 60);  // Sương mù xa

        const camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMap.enabled = true;
        document.body.appendChild(renderer.domElement);

        // Ánh sáng
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.7);
        scene.add(ambientLight);
        const sunLight = new THREE.DirectionalLight(0xffffff, 1.5);
        sunLight.position.set(10, 20, 10);
        sunLight.castShadow = true;
        scene.add(sunLight);

        // ==========================================
        // 3. HỆ THỐNG TẢI & GỘP HOẠT ẢNH (QUAN TRỌNG)
        // ==========================================
        const loader = new GLTFLoader();
        let hero, mixer;
        let actions = {}; // Chứa: { 'run': action, 'attack': action }
        let activeAction, lastAction;
        
        // Hàm cập nhật loading text
        const setStatus = (txt) => document.getElementById('loading-text').innerText = txt;

        // BẮT ĐẦU TẢI
        (async function loadGameAssets() {
            try {
                // A. Tải Môi Trường (Meadow)
                setStatus("ĐANG TẢI ĐỒNG CỎ...");
                const mapGltf = await loadModel(getUrl(CONFIG.files.map));
                scene.add(mapGltf.scene);

                // B. Tải Nhân Vật (Hero - Có da thịt)
                setStatus("ĐANG TẢI CHIẾN BINH...");
                const heroGltf = await loadModel(getUrl(CONFIG.files.hero));
                hero = heroGltf.scene;
                
                // Fix kích thước Hero (Cao khoảng 1.8m)
                const box = new THREE.Box3().setFromObject(hero);
                const size = box.getSize(new THREE.Vector3());
                const scale = 1.8 / size.y; 
                hero.scale.set(scale, scale, scale);
                
                hero.traverse(c => { if(c.isMesh) { c.castShadow = true; } });
                scene.add(hero);

                // Khởi tạo Mixer (Bộ trộn hoạt ảnh) cho Hero
                mixer = new THREE.AnimationMixer(hero);

                // C. Tải Hoạt Ảnh Rời (Run & Attack - Không da)
                // Đây là bước "Gộp" quan trọng nhất
                setStatus("ĐANG GỘP HOẠT ẢNH...");
                
                // Tải file Run
                const runGltf = await loadModel(getUrl(CONFIG.files.run));
                if(runGltf.animations.length > 0) {
                    const clip = runGltf.animations[0];
                    const action = mixer.clipAction(clip);
                    actions['run'] = action;
                }

                // Tải file Attack
                const atkGltf = await loadModel(getUrl(CONFIG.files.attack));
                if(atkGltf.animations.length > 0) {
                    const clip = atkGltf.animations[0];
                    const action = mixer.clipAction(clip);
                    action.setLoop(THREE.LoopOnce); // Chém 1 lần rồi thôi
                    action.clampWhenFinished = true; // Giữ nguyên tư thế cuối
                    actions['attack'] = action;
                }

                // Xong xuôi -> Vào game
                document.getElementById('loader-screen').style.opacity = 0;
                setTimeout(() => document.getElementById('loader-screen').style.display = 'none', 500);

            } catch (error) {
                console.error(error);
                setStatus("LỖI: KHÔNG TÌM THẤY FILE!");
                document.getElementById('loading-text').style.color = 'red';
                alert("Lỗi: Hãy kiểm tra xem bạn đã đổi tên file thành hero.glb, run.glb... chưa?");
            }
        })();

        // Hàm hỗ trợ tải file (Promise wrapper)
        function loadModel(url) {
            return new Promise((resolve, reject) => {
                loader.load(url, resolve, undefined, reject);
            });
        }

        // ==========================================
        // 4. HỆ THỐNG ĐIỀU KHIỂN (INPUT)
        // ==========================================
        let moveVec = new THREE.Vector2();
        let isAttacking = false;

        // Joystick Logic
        const joyZone = document.getElementById('joystick-zone');
        const joyKnob = document.getElementById('joystick-knob');

        joyZone.addEventListener('touchmove', handleJoystick);
        joyZone.addEventListener('touchstart', handleJoystick);
        
        function handleJoystick(e) {
            e.preventDefault();
            const touch = e.touches[0];
            const rect = joyZone.getBoundingClientRect();
            const centerX = rect.left + rect.width/2;
            const centerY = rect.top + rect.height/2;
            
            // Tính toán vector
            let x = touch.clientX - centerX;
            let y = touch.clientY - centerY;
            
            // Giới hạn bán kính xoay (40px)
            const dist = Math.min(Math.sqrt(x*x + y*y), 40);
            const angle = Math.atan2(y, x);
            
            x = Math.cos(angle) * dist;
            y = Math.sin(angle) * dist;

            // Di chuyển nút
            joyKnob.style.transform = `translate(-50%, -50%) translate(${x}px, ${y}px)`;
            
            // Lưu giá trị điều khiển (chuẩn hóa 0-1)
            moveVec.set(x/40, y/40);
        }

        joyZone.addEventListener('touchend', () => {
            joyKnob.style.transform = `translate(-50%, -50%)`;
            moveVec.set(0, 0);
        });

        // Attack Logic
        document.getElementById('btn-attack').addEventListener('touchstart', (e) => {
            e.preventDefault();
            if(!actions['attack'] || isAttacking) return; // Nếu chưa có anim hoặc đang chém thì thôi

            isAttacking = true;
            fadeToAction('attack', 0.1); // Chuyển sang chém thật nhanh (0.1s)

            // Tính thời gian hồi (dựa trên độ dài animation)
            const duration = actions['attack'].getClip().duration;
            
            setTimeout(() => {
                isAttacking = false;
                if(moveVec.length() > 0.1) fadeToAction('run', 0.2);
                else fadeToAction(null, 0.2); // Về trạng thái nghỉ (hoặc idle nếu có)
            }, duration * 1000 - 100); // Trừ hao chút xíu cho mượt
        });

        // Hàm chuyển đổi Animation mượt (Blending)
        function fadeToAction(name, duration) {
            if (activeAction === actions[name]) return;

            previousAction = activeAction;
            activeAction = actions[name];

            if (previousAction) {
                previousAction.fadeOut(duration);
            }

            if (activeAction) {
                activeAction.reset().fadeIn(duration).play();
            }
        }

        // ==========================================
        // 5. VÒNG LẶP GAME (GAME LOOP)
        // ==========================================
        const clock = new THREE.Clock();

        function animate() {
            requestAnimationFrame(animate);
            const dt = clock.getDelta();
            if (mixer) mixer.update(dt);

            if (hero) {
                // XỬ LÝ DI CHUYỂN
                if (moveVec.length() > 0.1 && !isAttacking) {
                    // Xoay nhân vật theo hướng Joystick
                    const targetRot = Math.atan2(moveVec.x, moveVec.y);
                    
                    // Xoay mượt (Lerp rotation)
                    let rotDiff = targetRot - hero.rotation.y;
                    // Chuẩn hóa góc quay (-PI đến PI) để không xoay vòng tròn vô nghĩa
                    while (rotDiff > Math.PI) rotDiff -= Math.PI * 2;
                    while (rotDiff < -Math.PI) rotDiff += Math.PI * 2;
                    hero.rotation.y += rotDiff * 10 * dt;

                    // Di chuyển vị trí
                    const speed = 5 * dt; // Tốc độ chạy
                    hero.position.x += Math.sin(hero.rotation.y) * speed;
                    hero.position.z += Math.cos(hero.rotation.y) * speed;

                    // Kích hoạt animation chạy
                    fadeToAction('run', 0.2);
                } else if (!isAttacking) {
                    // Đứng yên
                    fadeToAction(null, 0.2); // Nếu có 'idle' thì thay null bằng 'idle'
                }

                // CAMERA FOLLOW (MƯỢT)
                const camDist = 8;
                const camHeight = 6;
                // Camera luôn đi theo sau lưng nhân vật một chút
                const targetX = hero.position.x;
                const targetZ = hero.position.z + camDist;
                
                camera.position.x += (targetX - camera.position.x) * 5 * dt;
                camera.position.z += (targetZ - camera.position.z) * 5 * dt;
                camera.position.y = hero.position.y + camHeight;
                camera.lookAt(hero.position);
            }

            renderer.render(scene, camera);
        }
        animate();

        // Xử lý khi xoay màn hình
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

    </script>
</body>
</html>
